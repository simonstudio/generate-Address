<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>

    <script src="https://code.jquery.com/jquery-3.6.1.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.6/dist/umd/popper.min.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.1/dist/css/bootstrap.min.css" rel="stylesheet" />
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.1/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.1/dist/js/bootstrap.min.js"></script>
    <script src="https://cdn.socket.io/4.5.0/socket.io.min.js"></script>
</head>

<body>
    <div class="container text-center">
        <div class="row">
            <div class="col">
                <button type="button" class="btn btn-primary" id="btnRun">Run</button>
                <button id="postINFURA_API_KEYS">post INFURA API KEYS</button>
            </div>
        </div>
        <div class="row">
            <div class="col">
                <div id="count_query">s</div>
                <div id="address">s</div>
                <div id="private">s</div>
                <div id="error" class="alert alert-danger">s</div>
            </div>
            <div class="col">
                <textarea id="txtINFURA_API_KEYS"> infura Token</textarea>
            </div>
        </div>
        <div class="row" id="goodWallets">
            <div class="row">
                <div class="col address">g</div>
                <div class="col private">g</div>
                <div class="col balance">g</div>
                <div class="col chain">g</div>
            </div>
        </div>
    </div>
    <script>
        var socket = io();
        var STATE = {
            RUN: false,
            goodWallets: []
        }

        function viewGoodWallets() {
            $('#goodWallets').html(
                STATE.goodWallets.map(a => {
                    return `<div class="row">
                    <div class="col address">${a.address}</div>
                    <div class="col private">${a.privateKey}</div>
                    <div class="col balance">${a.balance}</div>
                    <div class="col chain">${a.chain}</div>
                </div>`
                }).join("\n")
            )
        }

        $('#postINFURA_API_KEYS').click(e => {
            socket.emit('INFURA_API_KEYS', {
                INFURA_API_KEYS: $('#txtINFURA_API_KEYS').val().split("\n").filter(v => v.trim() !== "")
            })
        });

        $('#btnRun').click(e => {
            if (!STATE.RUN)
                socket.emit('count_query', "run_now");
            else
                socket.emit('count_query', "pause_now")
        });
        socket.on("connect", () => {
            console.log("connected", socket.id);
            socket.emit('count_query', "get_state")
        });

        socket.on("count_query", (msg) => {
            if (msg.RUN == true) {
                STATE.RUN = true;
                $("#btnRun").text("PAUSE");
                $("#btnRun").toggleClass("btn-primary btn-danger");
            } else if (msg.RUN == false) {
                STATE.RUN = false;
                $("#btnRun").text("RUN");
                $("#btnRun").toggleClass("btn-danger btn-primary")
            }
            if (msg.error) {
                $('#error').text(msg.error).show();
                // alert(msg.error)
            } else
                $('#error').hide();
            // console.log(msg.RUN);
            $('#count_query').text(msg.count);
            $('#address').text(msg.address);
            $('#private').text(msg.privateKey);
            $('#balance').text(msg.balance);

        })

        socket.on("goodWallets", (msg) => {
            STATE.goodWallets.push(msg);
            localStorage.setItem('goodWallets', JSON.stringify(STATE.goodWallets));
            viewGoodWallets()
        });

        $(document).ready(() => {
            try {
                STATE.goodWallets = JSON.parse(localStorage.getItem('goodWallets'));
            } catch (error) {
                STATE.goodWallets = []
            }
            viewGoodWallets()
        })

    </script>

    <style>
        #txtINFURA_API_KEYS {
            width: 100%;
        }
    </style>
</body>

</html>